<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:url" content="http://hhvm-cn.com/blog/10649/improving-arrays-in-hack" />
  <meta property="og:site_name" content="HHVM"/>
  <meta property="og:title" content="Improving Arrays in Hack" />
  <meta property="og:image" content="http://hhvm-cn.com/static/og_image.png" />
  <meta property="og:description" content="  “…use collections whenever and wherever possible. However, 100% usage of collections is obviously not realistic given how much arrays are used in various c..." />

  <link rel="stylesheet" href="/css/main.css" media="screen">
  <link rel="icon" href="/static/favicon.png" type="image/x-icon">
  

  <title>Improving Arrays in Hack | HHVM</title>
  <meta name="description" content="  “…use collections whenever and wherever possible. However, 100% usage of collections is obviously not realistic given how much arrays are used in various c...">

  <link rel="canonical" href="http://hhvm-cn.com/blog/10649/improving-arrays-in-hack">
  <link rel="alternate" type="application/rss+xml" title="HHVM" href="http://hhvm-cn.com/feed.xml" />
</head>

  <body class="docsNavVisible">
    <div id="fixed_header" class="fixedHeaderContainer visible">
  <div class="headerWrapper wrapper">
    <header>
      <a href="http://hhvm-cn.com/">
        <img src="/static/logo.svg">
        <h2>HHVM</h2>
      </a>

      <div class="navigationWrapper navigationFull" id="flat_nav">
        <nav class="navigation">
          <ul>
            
              <li class="navItem">
                
                  <a href="https://docs.hhvm-cn.com/hhvm/getting-started/getting-started">安装</a>
                
              </li>
            
              <li class="navItem navItemActive">
                
                  <a href="/blog/">博客</a>
                
              </li>
            
              <li class="navItem">
                
                  <a href="http://docs.hhvm-cn.com/hhvm/">文档</a>
                
              </li>
            
              <li class="navItem">
                
                  <a href="http://github.com/facebook/hhvm">GitHub</a>
                
              </li>
            
              <li class="navItem">
                
                  <a href="http://hacklang-cn.org/">Hack</a>
                
              </li>
            
              <li class="navItem">
                
                  <a href="https://www.facebook.com/hhvm/">Facebook</a>
                
              </li>
            
              <li class="navItem">
                
                  <a href="https://twitter.com/HipHopVM">Twitter</a>
                
              </li>
            
              <li class="navItem">
                
                  <a href="http://webchat.freenode.net/?channels=hhvm">IRC</a>
                
              </li>
            
              <li class="navItem">
                
                  <a href="http://hhvm.h4cc.de/">模块支持</a>
                
              </li>
            
            
          </ul>
        </nav>
      </div>
      <div class="navigationWrapper navigationSlider" id="navigation_wrap">
        <div id="header_nav">
  <div class="navSlideout">
    <i class="menuExpand" id="header_nav_expander"><span></span><span></span><span></span></i>
  </div>
  <nav class="slidingNav">
    <ul>
      
      <li class="navItem">
        <a href="https://docs.hhvm-cn.com/hhvm/getting-started/getting-started" target="_blank">安装</a>
      </li>
      
      <li class="navItem">
        <a href="/blog/">博客</a>
      </li>
      
      <li class="navItem">
        <a href="http://docs.hhvm-cn.com/hhvm/" target="_blank">文档</a>
      </li>
      
      <li class="navItem">
        <a href="http://github.com/facebook/hhvm" target="_blank">GitHub</a>
      </li>
      
      <li class="navItem">
        <a href="http://hacklang-cn.org/" target="_blank">Hack</a>
      </li>
      
      <li class="navItem">
        <a href="https://www.facebook.com/hhvm/" target="_blank">Facebook</a>
      </li>
      
      <li class="navItem">
        <a href="https://twitter.com/HipHopVM" target="_blank">Twitter</a>
      </li>
      
      <li class="navItem">
        <a href="http://webchat.freenode.net/?channels=hhvm" target="_blank">IRC</a>
      </li>
      
      <li class="navItem">
        <a href="http://hhvm.h4cc.de/" target="_blank">模块支持</a>
      </li>
      
      
    </ul>
  </nav>
</div>
<script>
  var event = document.createEvent('Event');
  event.initEvent('slide', true, true);
  document.addEventListener('slide', function (e) {
    document.body.classList.toggle('sliderActive');
  }, false);
  var headerNav = document.getElementById('header_nav');
  var headerNavExpander = document.getElementById('header_nav_expander');
  headerNavExpander.addEventListener('click', function(e) {
    headerNav.classList.toggle('navSlideoutActive');
    document.dispatchEvent(event);
  }, false);
</script>
      </div>
    </header>
  </div>
</div>

    <div class="navPusher">
      <div class="docMainWrapper wrapper">
      <div class="docsNavContainer">
  <nav class="toc" id="doc_nav">
    <div class="toggleNav" id="collection_nav">
      <section class="navWrapper wrapper">
        <div class="navBreadcrumb wrapper">
          <div class="navToggle" id="collection_nav_toggler">
            <i></i>
          </div>
          <h2>
            <a href="/blog/">Blog</a>
            
          </h2>
        </div>
        <div class="navGroups">
          
            
            
            <div class="navGroup navGroupActive navGroupCurrent">
  <h3><i>+</i><span>All Posts</span></h3>
  <ul>
    
      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/05/04/hhvm-4.56.html">HHVM 4.56</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/04/30/security-update.html">Security Update</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/04/29/hhvm-4.55.html">HHVM 4.55</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/04/21/hhvm-4.54.html">HHVM 4.54</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/04/13/hhvm-4.53.html">HHVM 4.53</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/04/07/hhvm-4.52.html">HHVM 4.52</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/03/31/hhvm-4.51.html">HHVM 4.51</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/03/24/hhvm-4.50.html">HHVM 4.50</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/03/18/hhvm-4.49.html">HHVM 4.49</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/03/09/hhvm-4.48.html">HHVM 4.48</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/03/03/hhvm-4.47.html">HHVM 4.47</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/02/24/hhvm-4.46.html">HHVM 4.46</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/02/20/security-update.html">Security Update</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/02/19/hhvm-4.45.html">HHVM 4.45</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/02/10/hhvm-4.44.html">HHVM 4.44</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/02/03/hhvm-4.43.html">HHVM 4.43</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/01/27/hhvm-4.42.html">HHVM 4.42</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/01/21/hhvm-4.41.html">HHVM 4.41</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/01/13/hhvm-4.40.html">HHVM 4.40</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/01/07/hhvm-4.39.html">HHVM 4.39</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2020/01/02/hhvm-4.38.html">HHVM 4.38</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/12/17/cancelling-hhvm-4.37.html">Holiday schedule: cancelling HHVM 4.37</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/12/16/hhvm-4.36.html">HHVM 4.36</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/12/10/hhvm-4.35.html">HHVM 4.35</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/12/02/hhvm-4.34.html">HHVM 4.34</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/11/25/hhvm-4.33.html">HHVM 4.33</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/11/19/hhvm-4.32.html">HHVM 4.32 (LTS)</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/11/19/distribution-support.html">Support lifecycle for older distributions</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/11/11/hhvm-4.31.html">HHVM 4.31.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/11/06/hhvm-4.30.html">HHVM 4.30.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/10/29/hhvm-4.29.html">HHVM 4.29.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/10/28/security-update.html">Security Update</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/10/23/hhvm-4.28.html">HHVM 4.28</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/10/14/hhvm-4.27.0.html">HHVM 4.27.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/10/09/hhvm-4.26.0.html">HHVM 4.26.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/10/01/deprecating-references.html">Deprecating &$references</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/09/30/hhvm-4.25.0.html">HHVM 4.25.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/09/25/security-update.html">Security Update</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/09/23/hhvm-4.24.0.html">HHVM 4.24.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/09/17/hhvm-4.23.0.html">HHVM 4.23.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/09/09/hhvm-4.22.0.html">HHVM 4.22.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/09/03/the-hhvm-4.21.0.html">HHVM 4.21.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/09/03/security-update.html">Security Update</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/08/27/hhvm-4.20.0.html">HHVM 4.20.0 and 4.20.1</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/08/19/hhvm-4.19.0.html">HHVM 4.19.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/08/14/security-update.html">Security Update</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/08/12/hhvm-4.18.0.html">HHVM 4.18.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/08/07/bugfixes.html">Bugfixes for 3.30, 4.8, and 4.12-17</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/08/05/hhvm-4.17.0.html">HHVM 4.17.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/07/29/hhvm-4.16.0.html">HHVM 4.16.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/07/22/hhvm-4.15.0.html">HHVM 4.15.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/07/15/hhvm-4.14.0.html">HHVM 4.14.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/07/09/hhvm-4.13.0.html">HHVM 4.13.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/07/01/hhvm-4.12.0.html">HHVM 4.12.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/06/24/hhvm-4.11.0.html">HHVM 4.11.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/06/18/hhvm-4.10.0.html">HHVM 4.10.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/06/13/hhvm-4.9.1.html">HHVM 4.9.1, repository changes</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/06/10/hhvm-4.9.0.html">HHVM 4.9.0, and security updates for 3.30, and 4.3-4.7</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/06/03/hhvm-4.8.0.html">HHVM 4.8.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/05/28/hhvm-4.7.0.html">HHVM 4.7.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/05/21/hhvm-4.6.0.html">HHVM 4.6.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/05/13/hhvm-4.5.0.html">HHVM 4.5.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/05/06/hhvm-4.4.0.html">HHVM 4.4.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/04/30/hhvm-4.3.0.html">HHVM 4.3.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/04/23/hhvm-4.2.0.html">HHVM 4.2.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/04/09/hhvm-4.1.0.html">HHVM 4.1.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/04/03/hhvm-4.0.4.html">HHVM 4.0.4, 3.30.5, and 3.27.8</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/02/28/hhvm-4.0.3.html">HHVM 4.0.3</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/02/19/hhvm-4.0.2.html">HHVM 4.0.2</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/02/14/hhvm-4.0.1.html">HHVM 4.0.1, 3.30.4, and 3.27.7: CVE-2019-3552</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/02/11/hhvm-4.0.0.html">HHVM 4.0.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/02/01/hhvm-3.30.3.html">HHVM 3.30.3</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2019/01/14/hhvm-3.30.2.html">HHVM 3.30.2 and 3.27.6</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/12/18/hhvm-3.30.1.html">HHVM 3.30.1 and 3.27.5</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/12/17/hhvm-3.30.html">HHVM 3.30</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/10/30/hhvm-3.29.1.html">HHVM 3.29.1 and 3.27.4</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/10/22/hhvm-3.29.html">HHVM 3.29</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/10/01/hhvm-3.28.3.html">HHVM 3.28.3</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/09/28/hhvm-3.28.2.html">HHVM 3.28.2 and 3.27.3</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/09/26/introducing-hacktest.html">Introducing HackTest</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/09/12/end-of-php-support-future-of-hack.html">Ending PHP Support, and The Future Of Hack</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/08/30/hhvm-3.28.1.html">HHVM 3.28.1</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/08/28/hhvm-3.28.0.html">HHVM 3.28.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/08/15/hhvm-3.27.2.html">HHVM 3.27.2</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/07/19/hhvm-3.27.1.html">HHVM 3.27.1 and 3.24.8</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/06/18/hhvm-3.27.0.html">HHVM 3.27.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/05/24/hhvm-3.26.3.html">HHVM 3.26.3</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/05/15/hhvm-3.26.2.html">HHVM 3.26.2</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/05/11/hhvm-3.26.1.html">HHVM 3.26.1</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/05/07/hhvm-3.26.html">HHVM 3.26 - Introducing HackC</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/05/04/hhvm-3.25.3.html">HHVM 3.25.3, HHVM 3.24.7, and 3.21.11</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/04/11/relicensing-hack.html">Relicensing Hack</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/03/30/hhvm-3.25.2.html">HHVM 3.25.2, HHVM 3.24.6, and 3.21.10 (CVE-2018-6334)</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/03/22/hhvm-3.25.1.html">HHVM 3.25.1, HHVM 3.24.5, and 3.21.9</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/03/15/hhvm-3.25.html">HHVM 3.25.0, 3.24.4, and 3.21.8</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/03/02/hhvm-3.24.3.html">HHVM 3.24.3 and 3.21.7</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/02/07/hhvm-3.24.2.html">HHVM 3.24.2</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/01/30/hhvm-3.24.1.html">HHVM 3.24.1, 3.21.6, and 3.18.8</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/01/16/hhvm-3.24.html">HHVM 3.24</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/01/12/hhvm-3.23.4.html">HHVM 3.23.4, 3.21.5, and 3.18.7</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2018/01/02/hhvm-3.23.3.html">HHVM 3.23.3, 3.21.4, and 3.18.6</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2017/11/17/hhvm-3-23.html">HHVM 3.23</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2017/11/14/gpg-key-migration.html">GPG Key Migration</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2017/10/26/the-hack-standard-library-1-0.html">The Hack Standard Library: v1.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2017/09/26/hhvm-3-22.html">HHVM 3.22</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2017/09/18/the-future-of-hhvm.html">The Future of HHVM</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2017/08/02/hhvm-3-21.html">HHVM 3.21</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2017/06/07/hhvm-3-20.html">HHVM 3.20</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2017/04/13/hhvm-3-19.html">HHVM 3.19</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2017/03/23/concurrent-jit-compilation.html">Concurrent JIT Compilation</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2017/03/09/how-the-cyber-elephant-got-his-arm.html">How the Cyber-Elephant Got His ARM</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2017/02/17/region-jit.html">HHVM's Profile-guided Region JIT</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2017/02/15/hhvm-3-18.html">HHVM 3.18</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2017/01/26/new-year-new-me.html">New Year, New Me</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/11711/hhvm-3-15">HHVM 3.15</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/10925/improved-user-documentation">Improved User Documentation</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/10859/php-7-support">PHP 7 Support</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/10649/improving-arrays-in-hack">Improving Arrays in Hack</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/10205/llvm-code-generation-in-hhvm">LLVM Code Generation in HHVM</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/10379/hhvm-3-10-0">HHVM 3.10.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/10043/experimental-mac-os-x-support">Experimental Mac OS X Support</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/9995/hhvm-3-9-0">HHVM 3.9.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/9803/hhvm-3-8-0">HHVM 3.8.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/9773/cve-2015-4663">CVE-2015-4663</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/9581/trait-and-interface-requirements-in-hack">Trait and interface requirements in Hack</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/9293/lockdown-results-and-hhvm-performance">Lockdown Results and HHVM Performance</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/9215/covariance-contravariance-and-super-type-constraints">Covariance, Contravariance, and super Type Constraints</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/9089/hhvm-lockdown">HHVM Lockdown</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/9059/hhvm-3-7-0">HHVM 3.7.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/8981/announcing-our-book-hack-hhvm">Announcing our book: “Hack & HHVM”</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/8939/etsys-transition-to-hhvm">Etsy's Transition to HHVM</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/8849/hhvm-3-6-0">HHVM 3.6.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/8537/announcing-a-specification-for-hack">Announcing a Specification for Hack</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/8405/coming-soon-in-hhvm">Coming Soon in HHVM</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/7637/hhvm-3-5-0">HHVM 3.5.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/7205/wikipedia-on-hhvm">Wikipedia on HHVM</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/7349/lts-updates">LTS Updates</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/7091/async-cooperative-multitasking-for-hack">Async - Cooperative Multitasking for Hack</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/6989/wp-engine-and-box-now-use-hhvm">WP Engine and Box now use HHVM</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/6899/hhvm-3-4-0">HHVM 3.4.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/6863/announcing-the-hack-transpiler">Announcing the Hack Transpiler</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/6473/hack-overriding-constructors-new-static-and-__consistentconstruct">Hack: Overriding Constructors, "new static", and __ConsistentConstruct</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/6767/hhvm-3-3-1">HHVM 3.3.1</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/6515/using-xhp-with-bootstrap">Using XHP with Bootstrap</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/6443/hack-recent-updates">Hack: Recent Updates</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/6323/the-journey-of-a-thousand-bytecodes">The Journey of a Thousand Bytecodes</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/6239/hhvm-3-3-0">HHVM 3.3.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/6083/hhvm-long-term-support">HHVM Long Term Support</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/6005/hack-community-roundup-3">Hack Community Roundup #3</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/5723/announcing-a-specification-for-php">Announcing a specification for PHP</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/5609/hhvm-3-2-0">HHVM 3.2.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/5399/faster-github-commits">Faster GitHub Commits</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/5429/hack-community-roundup-2">Hack Community Roundup #2</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/5195/hhvm-3-1-0">HHVM 3.1.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/4811/hack-community-roundup">Hack Community Roundup</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/4841/compatibility-update">Compatibility Update</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/4685/hack-developer-day-2014-keep-hacking">Hack Developer Day 2014: Keep Hacking</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/4601/debug-packages">Debug Packages</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/4349/hhvm-3-0-0">HHVM 3.0.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/4325/hacking-hack-on-heroku">Hacking Hack on Heroku</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/4223/introducing-hack-a-programming-language-for-hhvm">Introducing Hack - A Programming Language for HHVM</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/4103/hhvm-2-4-2">HHVM 2.4.2</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/3611/tracking-parity">Tracking Parity</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/3689/implementing-mysqli">Implementing MySQLi</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/3743/hhvm-the-next-six-months">HHVM: The Next Six Months</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/3287/hhvm-2-4-0">HHVM 2.4.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/3203/nightly-packages">Nightly Packages</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2813/we-are-the-98-5-and-the-16">We are the 98.5% (and the 16%)</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/1817/fastercgi-with-hhvm">FasterCGI with HHVM</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2393/hhvm-2-3-0-and-travis-ci">HHVM 2.3.0 and Travis CI</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/2027/faster-and-cheaper-the-evolution-of-the-hhvm-jit">Faster and Cheaper: The Evolution of the hhvm JIT</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/1499/locking-down-for-performance-and-parity">Locking Down for Performance and Parity </a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/1379/hhvm-on-heroku">HHVM on Heroku</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/1301/hhvm-2-2-0">HHVM 2.2.0</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/875/wow-hhvm-is-fast-too-bad-it-doesnt-run-my-code">Wow HHVM is fast...too bad it doesn’t run my code</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/713/hhvm-optimization-tips">HHVM Optimization Tips</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/575/joining-retirement-testing-and-bankruptcy">Joining, Retirement, Testing, and Bankruptcy</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/521/the-adminserver">The AdminServer</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/431/on-garbage-collection">On Garbage Collection</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/401/spammers-are-still-a-thing-it-seems">Spammers are still a thing, it seems</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/311/adding-an-opcode-to-hhbc">Adding an opcode to HHBC</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/4061/go-faster">Go Faster!</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/3095/getting-wordpress-running-on-hhvm">Getting WordPress running on HHVM</a></li>

      
      <li class="navListItem"><a class="navItem" href="http://hhvm-cn.com/blog/3089/wordpress-3-4-2-running-on-hiphop-hhvm">WordPress 3.4.2 running on HHVM</a></li>

      
    
  </ul>
</div>
          
        </div>
      </section>
    </div>
  </nav>
</div>
<script>
  var docsevent = document.createEvent('Event');
  docsevent.initEvent('docs_slide', true, true);
  document.addEventListener('docs_slide', function (e) {
    document.body.classList.toggle('docsSliderActive');
  }, false);

  var collectionNav = document.getElementById('collection_nav');
  var collectionNavToggler = 
    document.getElementById('collection_nav_toggler');
  collectionNavToggler.addEventListener('click', function(e) {
    collectionNav.classList.toggle('toggleNavActive');
    document.dispatchEvent(docsevent);
  });

  var groups = document.getElementsByClassName('navGroup');
  for(var i = 0; i < groups.length; i++) {
    var thisGroup = groups[i];
    thisGroup.onclick = function() {
      for(var j = 0; j < groups.length; j++) {
        var group = groups[j];
        group.classList.remove('navGroupActive');
      }
      this.classList.add('navGroupActive');
    }
  }
</script>


      <div class="mainContainer blogContainer postContainer">
  <div id="main_wrap" class="wrapper mainWrapper">
    <div class="lonePost">
<div class="post">
  
  <header class="post-header">
    
    <div class="authorPhoto">
      <img src="https://graph.facebook.com/712073/picture/" alt="" title="" />
    </div>
    
    
    <p class="post-authorName">Dwayne Reeves</p>
    
    <h1 class="post-title">Improving Arrays in Hack</h1>
    <p class="post-meta">Posted October 30, 2015</p>
  </header>

  <article class="post-content">
  
    <blockquote>
  <p>“<em>…use collections whenever and wherever possible. However, 100% usage of collections is obviously not realistic given how much arrays are used in various codebases …there just may be legitimate use cases for an array</em>”</p>
</blockquote>

<p>This is the guidance given to Hack developers on using arrays. While we still advise using collections whenever possible, in hindsight there are more “legitimate use cases” for arrays than we first believed. With that in mind, the team is planning on improving arrays so they are better supported in Hack. We’ve opened a number of issues on GitHub (<a href="https://github.com/facebook/hhvm/issues/6451">#6451</a>, <a href="https://github.com/facebook/hhvm/issues/6452">#6452</a>, <a href="https://github.com/facebook/hhvm/issues/6453">#6453</a>, <a href="https://github.com/facebook/hhvm/issues/6454">#6454</a>, <a href="https://github.com/facebook/hhvm/issues/6455">#6455</a>) with our initial plans. Since this would be a significant change in the language we are looking for feedback from the community. Before diving into what we are thinking of building, let’s take some time to examine the problem we want to solve.</p>

<!--truncate-->

<h2 id="the-problem-with-arrays-in-hack">The Problem with Arrays in Hack</h2>

<p>Arrays are the ubiquitous data structure in PHP, used to represent everything from lists, associated lists, sets, tuples, or even a bag of data. This flexibility itself makes it challenging for Hack to understand how an array will be used. Consider the example below. Should <code class="highlighter-rouge">$arr</code> be treated as a map-like array that contains both <code class="highlighter-rouge">int</code> s and <code class="highlighter-rouge">string</code>s or a shape-like array whose <code class="highlighter-rouge">id</code> field is an <code class="highlighter-rouge">int</code>, but <code class="highlighter-rouge">name</code> is a <code class="highlighter-rouge">string</code>? Currently whenever the type checker encounters ambiguity like this it errs towards not reporting errors and trusts the programmer knows what he/she is doing.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="rougeHighlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nv">$arr</span> <span class="o">=</span> <span class="p">[</span>
  <span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="mi">4</span><span class="p">,</span>
  <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'mark'</span><span class="p">,</span>
<span class="p">];</span>
<span class="nv">$name</span> <span class="o">=</span> <span class="nv">$arr</span><span class="p">[</span><span class="s1">'name'</span><span class="p">];</span>
<span class="nv">$arr</span><span class="p">[</span><span class="nv">$name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">ucfirst</span><span class="p">(</span><span class="nv">$name</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>If this was the only problem with PHP arrays, then the solution would be “simple”; make the type checker smarter (something we are working on). However there are a number of other semantic details around arrays that are nearly impossible to analyze statically.</p>

<h3 id="indexing-non-existent-keys">Indexing non-existent keys</h3>

<p>In many languages, attempting to index a non-existent key throws an exception and execution is halted. Instead of halting execution, PHP will raise a <code class="highlighter-rouge">E_NOTICE</code> and return <code class="highlighter-rouge">null</code>. The type checker is faced with a difficult decision: should it treat any index operation as producing a potentially nullable value or ignore this possibility? Hack today chooses to ignore the fact that indexing an array may produce a null value, allowing potential bugs to go undetected.</p>

<h3 id="key-coercion">Key coercion</h3>

<p>Arrays only support <code class="highlighter-rouge">string</code>s or <code class="highlighter-rouge">int</code>s as keys and coerces invalid types to one of these types. For instance, if a <code class="highlighter-rouge">float</code> is used as a key, it will be truncated to an <code class="highlighter-rouge">int</code>. Hack chooses not to support these key coercions and the type checker will report an error if you try to use a <code class="highlighter-rouge">float</code> as a key. But there is one coercion that the type checker cannot detect, which is the conversion of int-like strings to be <code class="highlighter-rouge">int</code>. This can lead to unexpected failures at runtime, as demonstrated in the code example below.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="rougeHighlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">expects_string</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$s</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span> <span class="p">{}</span>

<span class="k">function</span> <span class="nf">will_fail_at_runtime</span><span class="p">()</span><span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>
 <span class="c1">// Hack believes $arr is type array&lt;string, int&gt;
</span> <span class="nv">$arr</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s1">'123'</span> <span class="o">=&gt;</span> <span class="mi">123</span><span class="p">);</span>

 <span class="k">foreach</span> <span class="p">(</span><span class="nv">$arr</span> <span class="k">as</span> <span class="nv">$k</span> <span class="o">=&gt;</span> <span class="nv">$_</span><span class="p">)</span> <span class="p">{</span>
   <span class="c1">// The string '123' will be changed to int(123), triggering a
</span>   <span class="c1">// TypeHintException at runtime
</span>   <span class="nx">expects_string</span><span class="p">(</span><span class="nv">$k</span><span class="p">);</span>
 <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="arrays-containing-references">Arrays containing references</h3>

<p>A more subtle semantic detail is how arrays behave when storing references. In particular, in some instances, a reference will be flattened to a value if the array contains the only reference to that value. This behavior is demonstrated below.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="rougeHighlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="nv">$x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nv">$arr1</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$x</span><span class="p">);</span>

<span class="nv">$arr2</span> <span class="o">=</span> <span class="nv">$arr1</span><span class="p">;</span>
<span class="nv">$arr2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$arr1</span><span class="p">,</span> <span class="nv">$arr2</span><span class="p">);</span>
<span class="cm">/* Changes in $arr2 reflected in $arr1
array(1) {
 [0]=&gt;
 &amp;int(1)
}
array(1) {
 [0]=&gt;
 &amp;int(1)
}
*/</span>

<span class="nb">unset</span><span class="p">(</span><span class="nv">$x</span><span class="p">);</span>
<span class="nv">$arr2</span> <span class="o">=</span> <span class="nv">$arr1</span><span class="p">;</span>
<span class="nv">$arr2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="nb">var_dump</span><span class="p">(</span><span class="nv">$arr1</span><span class="p">,</span> <span class="nv">$arr2</span><span class="p">);</span>
<span class="cm">/* Changes in $arr2 no longer reflected in $arr1
array(1) {
 [0]=&gt;
 int(1)
}
array(1) {
 [0]=&gt;
 int(2)
}
*/</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Here we begin by storing a reference to <code class="highlighter-rouge">$x</code> inside an array. We then assign the array to another variable <code class="highlighter-rouge">$arr2</code> and increment the value stored in the array. Since we stored a reference, the change will be reflected in both <code class="highlighter-rouge">$arr1</code> and <code class="highlighter-rouge">$arr2</code>. But if we run the same code after unsetting <code class="highlighter-rouge">$x</code> we get a different result. When we reassign <code class="highlighter-rouge">$arr1</code> to <code class="highlighter-rouge">$arr2</code>, the ref count of <code class="highlighter-rouge">$arr1[0]</code> drops to one and is flattened to a value. Now changes to <code class="highlighter-rouge">$arr2</code> are no longer reflected in <code class="highlighter-rouge">$arr1</code>. This is again behavior the type checker turns a blind eye to when dealing with arrays.</p>

<h2 id="legitimate-use-cases">Legitimate Use Cases</h2>

<p>These quirks of arrays motivated the creation of collections in Hack. At the time we believed usage of arrays would dwindle over time and collections would be used everywhere. In retrospect we realized there are legitimate reasons why a programmer may want to choose an array over a collection, primarily due to the fact arrays are values while collections are mutable objects. Arrays being values have certain advantages over collections that cannot be closed without significantly changing how collections work.</p>

<h3 id="values-are-eligible-for-more-optimizations">Values are eligible for more optimizations</h3>

<p>To understand why this is the case, you have to be familiar with the execution model of HHVM, which was inherited from PHP. PHP has a shared-nothing model where data is not shared between requests. After each request all objects that were allocated are dumped and the next request starts with a clean slate. Consider the following code:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="rougeHighlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?</span><span class="nx">hh</span>
<span class="k">class</span> <span class="nc">MyConfig</span> <span class="p">{</span>
 <span class="k">private</span> <span class="k">static</span> <span class="nx">Map</span><span class="o">&lt;</span><span class="nx">int</span><span class="p">,</span> <span class="nx">string</span><span class="o">&gt;</span> <span class="nv">$collection</span> <span class="o">=</span> <span class="nx">ImmMap</span> <span class="p">{</span>
   <span class="o">...</span> <span class="c1">// statically map 100 ints to some string
</span> <span class="p">};</span>

 <span class="k">private</span> <span class="k">static</span> <span class="k">array</span><span class="o">&lt;</span><span class="nx">int</span><span class="p">,</span> <span class="nx">string</span><span class="o">&gt;</span> <span class="nv">$array</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
   <span class="o">...</span> <span class="c1">// same mapping as above
</span> <span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>In most languages, the static initializer of a variable is run once at the start of the program. However, since HHVM is required to clear the world for each request, static initializers are run for each request. HHVM constructs the <code class="highlighter-rouge">ImmMap</code> of <code class="highlighter-rouge">MyConfig::$collection</code> for every request, which can be a non-trivial amount of CPU. Since arrays are value-types, HHVM does not have to reconstruct <code class="highlighter-rouge">MyConfig::$array</code> for each request. Instead HHVM can initialize the array once at start up and reuse the same array for all requests (assuming the array only contains value types).</p>

<p>For similar reasons, storing and retrieving a collection from APC is more expensive than doing the same thing for an array. Given these performance ramifications, it is reasonable that someone would choose to use an array over a collection in these cases.</p>

<h3 id="values-are-less-prone-to-bugs">Values are less prone to bugs</h3>

<p>Collections are mutable by default. There are cases where this behavior is desirable, but in large part, mutability makes code more difficult to reason about. Consider the following code:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="rougeHighlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?</span><span class="nx">hh</span>
<span class="k">abstract</span> <span class="k">final</span> <span class="k">class</span> <span class="nc">FriendFetcher</span> <span class="p">{</span>

  <span class="cm">/* Memoize the list of friends we fetch for the user */</span>
  <span class="o">&lt;&lt;</span><span class="nx">__Memoize</span><span class="o">&gt;&gt;</span>
  <span class="k">public</span> <span class="k">static</span> <span class="nx">async</span> <span class="k">function</span> <span class="nf">forUser</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$id</span><span class="p">)</span><span class="o">:</span> <span class="nx">Awaitable</span><span class="o">&lt;</span><span class="nx">Set</span><span class="o">&lt;</span><span class="nx">int</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="nv">$ids</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">fetch_friend_ids_from_backend</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Set</span><span class="p">(</span><span class="nv">$ids</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">public</span> <span class="k">static</span> <span class="nx">async</span> <span class="k">function</span> <span class="nf">mutualFriends</span><span class="p">(</span>
    <span class="nx">int</span> <span class="nv">$id1</span><span class="p">,</span>
    <span class="nx">int</span> <span class="nv">$id2</span><span class="p">,</span>
  <span class="p">)</span><span class="o">:</span> <span class="nx">Awaitable</span><span class="o">&lt;</span><span class="nx">Set</span><span class="o">&lt;</span><span class="nx">int</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="c1">// fetch both set of friends
</span>    <span class="k">list</span><span class="p">(</span><span class="nv">$friends1</span><span class="p">,</span> <span class="nv">$friends2</span><span class="p">)</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">genva</span><span class="p">(</span>
      <span class="nx">self</span><span class="o">::</span><span class="na">forUser</span><span class="p">(</span><span class="nv">$id1</span><span class="p">),</span>
      <span class="nx">self</span><span class="o">::</span><span class="na">forUser</span><span class="p">(</span><span class="nv">$id2</span><span class="p">),</span>
    <span class="p">);</span>

    <span class="c1">// Union the two friend sets and retain only those
</span>    <span class="c1">// that appear in both sets
</span>    <span class="k">return</span> <span class="nv">$friends1</span>
      <span class="o">-&gt;</span><span class="na">addAll</span><span class="p">(</span><span class="nv">$friends2</span><span class="p">)</span>
      <span class="o">-&gt;</span><span class="na">retain</span><span class="p">(</span>
        <span class="nv">$friend</span> <span class="o">==&gt;</span>
          <span class="nv">$friends1</span><span class="o">-&gt;</span><span class="na">contains</span><span class="p">(</span><span class="nv">$friend</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="nv">$friends2</span><span class="o">-&gt;</span><span class="na">contains</span><span class="p">(</span><span class="nv">$friend</span><span class="p">)</span>
      <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This code computes the set of mutual friends between users. This uses a simple algorithm of fetching both users’ set of friends and intersecting them. However there is a subtle bug in this code. <code class="highlighter-rouge">FriendFetcher::forUser</code> is annotated with <code class="highlighter-rouge">&lt;&lt;__Memoize&gt;&gt;</code> . This caches the result of the method for a given user ID, saving the cost of fetching from the backend multiple times for the same result. This returns the same <code class="highlighter-rouge">Set</code> object for a given user. <code class="highlighter-rouge">FriendFetcher::mutualFriends</code> uses <code class="highlighter-rouge">Set::addAll</code> to union two sets of friends together, modifying the <code class="highlighter-rouge">Set</code> instead of returning a new <code class="highlighter-rouge">Set</code> object. This is the same <code class="highlighter-rouge">Set</code> object that is cached using the <code class="highlighter-rouge">&lt;&lt;__Memoize&gt;&gt;</code> annotation. The next time we call <code class="highlighter-rouge">FriendFetcher::forUser</code> for <code class="highlighter-rouge">$id1</code>, the <code class="highlighter-rouge">Set</code> returned will also contain the friends of <code class="highlighter-rouge">$id2</code>.</p>

<p>There are mechanisms to work around this such as using <code class="highlighter-rouge">ConstSet</code> to hide the <code class="highlighter-rouge">Set::addAll</code> method, using <code class="highlighter-rouge">ImmSet</code> to make it an error to add anything to the set, or making the type checker aware of this potential bug and warning against it. While they would address this particular problem, this illustrates the dangers of defaulting to mutable collections. We considered changing <code class="highlighter-rouge">Set</code> to be <code class="highlighter-rouge">ImmSet</code> and introducing a <code class="highlighter-rouge">MutSet</code> type, but this comes with its own set of complications. When a programmer wants to modify a set, they would need to copy the immutable set to a mutable set, and then remember to make the set immutable again. The copy-on write behavior of arrays is desirable in these cases since it allows writing code as you are working with mutable data, but keeps it local to the function. When an array is passed to or returned from a function, the programmer has the guarantee that it will not be modified unless explicitly passed by reference.</p>

<h3 id="values-are-easier-to-reason-about">Values are easier to reason about</h3>

<p>Another consequence of the mutable reference semantics of Collections is that their generics are <a href="https://en.wikipedia.org/wiki/Covariance_and_contravariance_(computer_science)">invariant</a>. What does this mean? Consider the following code:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="rougeHighlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">function</span> <span class="nf">expects_vector_of_mixed</span><span class="p">(</span><span class="nx">Vector</span><span class="o">&lt;</span><span class="nx">mixed</span><span class="o">&gt;</span> <span class="nv">$vec</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>
<span class="o">...</span>
<span class="p">}</span>

<span class="k">function</span> <span class="nf">expects_vector_of_string</span><span class="p">(</span><span class="nx">Vector</span><span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span> <span class="nv">$vec</span><span class="p">)</span><span class="o">:</span> <span class="nx">void</span> <span class="p">{</span>
 <span class="c1">// Hack Error!!!
</span> <span class="nx">expects_vector_of_mixed</span><span class="p">(</span><span class="nv">$vec</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Passing a <code class="highlighter-rouge">Vector&lt;string&gt;</code> to a function expecting a <code class="highlighter-rouge">Vector&lt;mixed&gt;</code> is not allowed by the type checker. This is because <code class="highlighter-rouge">expects_vector_of_mixed</code> could modify <code class="highlighter-rouge">$vec</code> by adding an <code class="highlighter-rouge">int</code> and now our <code class="highlighter-rouge">Vector&lt;string&gt;</code> no longer contains only <code class="highlighter-rouge">string</code>s. While we should prevent programmers from making this mistake, it is unintuitive to many programmers.</p>

<p>Because arrays are values we can avoid this issue. When an array is passed to another function we know that function cannot modify the array we gave it (assuming you do not use references). The variance of array type parameters are covariant, meaning it is safe to pass an <code class="highlighter-rouge">array&lt;string&gt;</code> to a function that expects an <code class="highlighter-rouge">array&lt;mixed&gt;</code>.</p>

<h2 id="planned-improvements">Planned Improvements</h2>

<p>Given the trade offs outlined with arrays and collections, we are exploring a third approach that combines the virtues of arrays and collections. It will be a value type like arrays, but have the clean semantics of collections. Details around these new kinds of arrays are being discussed and fleshed out in various issues on GitHub. Here is an outline of what we are thinking of building.</p>

<ul>
  <li>
    <p><a href="https://github.com/facebook/hhvm/issues/6451">#6451</a> - Introduce <code class="highlighter-rouge">vec&lt;T&gt;</code> array type to mirror the <code class="highlighter-rouge">Vector&lt;T&gt;</code> collection class</p>
  </li>
  <li>
    <p><a href="https://github.com/facebook/hhvm/issues/6452">#6452</a> - Introduce <code class="highlighter-rouge">dict&lt;Tk, Tv&gt;</code> array type to mirror the <code class="highlighter-rouge">Map&lt;Tk, Tv&gt;</code> collection class</p>
  </li>
  <li>
    <p><a href="https://github.com/facebook/hhvm/issues/6453">#6453</a> - Introduce <code class="highlighter-rouge">keyset&lt;T&gt;</code> array type to mirror the <code class="highlighter-rouge">Set&lt;T&gt;</code> collection class</p>
  </li>
  <li>
    <p><a href="https://github.com/facebook/hhvm/issues/6454">#6454</a> - Give stricter semantics for indexing these array types, while adding support for safely accessing potentially non-existent keys</p>
  </li>
  <li>
    <p><a href="https://github.com/facebook/hhvm/issues/6455">#6455</a> - New sugar syntax for de-nesting function calls</p>
  </li>
</ul>

<p>If you have thoughts around these ideas, we invite you to join the discussion on GitHub.</p>

<h2 id="looking-further-out">Looking Further Out</h2>

<p>Having three different container types adds additional overhead to Hack, but we feel if implemented properly Hack arrays and collections will eliminate almost all legitimate use cases of PHP arrays. We are committed to continuing our support for PHP arrays and collections in the language, but may evolve their role in the future. Here are some really high level ideas we are thinking about.</p>

<h3 id="php-arrays-for-php-apis">PHP arrays for PHP APIs</h3>

<p>Hack arrays will replace PHP arrays as the suggested value-type container in Hack, but PHP arrays will still be useful when integrating with PHP code. For instance when creating an .hhi file for a PHP library that expects PHP arrays.</p>

<p>In typical Hack code, PHP arrays should be avoided because of the surprising semantics they have at runtime. To discourage their usage we could change the type checker to be more conservative and report more potential errors with arrays. Some ideas include</p>

<ul>
  <li>
    <p>Make indexing a PHP array produce a nullable type</p>
  </li>
  <li>
    <p>Make storing a <code class="highlighter-rouge">string</code> key change the key type of a PHP array to <code class="highlighter-rouge">arraykey</code></p>
  </li>
  <li>
    <p>Make PHP and Hack arrays incompatible with one another</p>
  </li>
</ul>

<h3 id="move-collections-from-the-runtime-to-a-library">Move collections from the runtime to a library</h3>

<p>Hack arrays will free up the Collections API from being an exact replacement for arrays. This would allow us to take greater advantage of the fact that these are objects instead of values. One idea is to move the implementation of Collections from a HHVM built-in to a library written in Hack. This would lower the barrier for adding new features/capabilities to Collections. For example supporting objects as keys for <code class="highlighter-rouge">Map</code> or <code class="highlighter-rouge">Set</code>, or creating specialized collections like <code class="highlighter-rouge">IntMap</code> that are optimized for storing integer keys.</p>

    
      
      
        
          <h3> Comments </h3>
          <br/>
          <ul>
          
        
        <li><b>Orvid</b>: There are other ways to solve the problems you've presented here, and one is to introduce the concepts of immutable and const. I won't go into detail here, but if I knew which issue number to reply to, I could go into a bit more detail there.</li>
      
        
        <li><b>Josh Watzman</b>: Immutability has its own issues. IIRC the crux of it is whether it's transitive or not (all a class's members must also be immutable). That can be painful to program with, but is useful for a ton of compiler optimizations and assumptions.

Feel free to respond to one of the github issues above, or just grab us on IRC, since I know you're there anyways :)</li>
      
        
        <li><b>HHVM update for the week ending 2016-03-04 | Coding Aloud</b>: [&#8230;] DictArray: initial, runtime support, serialisation, literal syntax, converting from an array, runtime [&#8230;]</li>
      
        
        <li><b>HHVM update for the two months ending 2016-05-20 | Coding Aloud</b>: [&#8230;] continued work on the Hack array types (dict and vec so far, I&#8217;m guessing keyset will be along [&#8230;]</li>
      
        
        <li><b>Douglas</b>: Hack suffers from quickly adding a bunch of rushed alternatives to the same problems and keeping all the old ones.</li>
      
      
        </ul>
        <br/>
      
    
  
  
    <div class="fb-like pluginWrapper likeButtonWrapper" data-layout="button_count" data-action="like" data-show-faces="true" data-share="true"></div>
<script>
  window.fbAsyncInit = function() {
  FB.init({
    appId      : '1615782811974223',
    xfbml      : true,
    version    : 'v2.3'
  });
  };

  (function(d, s, id){
   var js, fjs = d.getElementsByTagName(s)[0];
   if (d.getElementById(id)) {return;}
   js = d.createElement(s); js.id = id;
   js.src = "//connect.facebook.net/en_US/sdk.js";
   fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>
    <div class="pluginWrapper twitterSharePlugin">
  <a href="https://twitter.com/share" class="twitter-share-button" data-hashtags="HHVM">Tweet</a>
</div>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  
  </article>
</div>

</div>
  </div>
</div>


      </div>
      <div class="footerContainer">
  <div id="footer_wrap" class="wrapper footerWrapper">
    <div class="footerBlocks">
      <div id="fb_oss" class="footerSection fbOpenSourceFooter">
          <svg class="facebookOSSLogoSvg" viewBox="0 0 1133.9 1133.9" x="0px" y="0px">
            <g>
              <path class="logoRing outerRing" d="M 498.3 3.7 c 153.6 88.9 307.3 177.7 461.1 266.2 c 7.6 4.4 10.3 9.1 10.3 17.8 c -0.3 179.1 -0.2 358.3 0 537.4 c 0 8.1 -2.4 12.8 -9.7 17.1 c -154.5 88.9 -308.8 178.1 -462.9 267.5 c -9 5.2 -15.5 5.3 -24.6 0.1 c -153.9 -89.2 -307.9 -178 -462.1 -266.8 C 3 838.8 0 833.9 0 825.1 c 0.3 -179.1 0.2 -358.3 0 -537.4 c 0 -8.6 2.6 -13.6 10.2 -18 C 164.4 180.9 318.4 92 472.4 3 C 477 -1.5 494.3 -0.7 498.3 3.7 Z M 48.8 555.3 c 0 79.9 0.2 159.9 -0.2 239.8 c -0.1 10 3 15.6 11.7 20.6 c 137.2 78.8 274.2 157.8 411 237.3 c 9.9 5.7 17 5.7 26.8 0.1 c 137.5 -79.8 275.2 -159.2 412.9 -238.5 c 7.4 -4.3 10.5 -8.9 10.5 -17.8 c -0.3 -160.2 -0.3 -320.5 0 -480.7 c 0 -8.8 -2.8 -13.6 -10.3 -18 C 772.1 218 633.1 137.8 494.2 57.4 c -6.5 -3.8 -11.5 -4.5 -18.5 -0.5 C 336.8 137.4 197.9 217.7 58.8 297.7 c -7.7 4.4 -10.2 9.2 -10.2 17.9 C 48.9 395.5 48.8 475.4 48.8 555.3 Z" />
              <path class="logoRing middleRing" d="M 184.4 555.9 c 0 -33.3 -1 -66.7 0.3 -100 c 1.9 -48 24.1 -86 64.7 -110.9 c 54.8 -33.6 110.7 -65.5 167 -96.6 c 45.7 -25.2 92.9 -24.7 138.6 1 c 54.4 30.6 108.7 61.5 162.2 93.7 c 44 26.5 67.3 66.8 68 118.4 c 0.9 63.2 0.9 126.5 0 189.7 c -0.7 50.6 -23.4 90.7 -66.6 116.9 c -55 33.4 -110.8 65.4 -167.1 96.5 c -43.4 24 -89 24.2 -132.3 0.5 c -57.5 -31.3 -114.2 -64 -170 -98.3 c -41 -25.1 -62.9 -63.7 -64.5 -112.2 C 183.5 621.9 184.3 588.9 184.4 555.9 Z M 232.9 556.3 c 0 29.5 0.5 59.1 -0.1 88.6 c -0.8 39.2 16.9 67.1 50.2 86.2 c 51.2 29.4 102.2 59.2 153.4 88.4 c 31.4 17.9 63.6 18.3 95 0.6 c 53.7 -30.3 107.1 -61.2 160.3 -92.5 c 29.7 -17.5 45 -44.5 45.3 -78.8 c 0.6 -61.7 0.5 -123.5 0 -185.2 c -0.3 -34.4 -15.3 -61.5 -44.9 -79 C 637.7 352.6 583 320.8 527.9 290 c -27.5 -15.4 -57.2 -16.1 -84.7 -0.7 c -56.9 31.6 -113.4 64 -169.1 97.6 c -26.4 15.9 -40.7 41.3 -41.1 72.9 C 232.6 491.9 232.9 524.1 232.9 556.3 Z" />
              <path class="logoRing innerRing" d="M 484.9 424.4 c 69.8 -2.8 133.2 57.8 132.6 132 C 617 630 558.5 688.7 484.9 689.1 c -75.1 0.4 -132.6 -63.6 -132.7 -132.7 C 352.1 485 413.4 421.5 484.9 424.4 Z M 401.3 556.7 c -3.4 37.2 30.5 83.6 83 84.1 c 46.6 0.4 84.8 -37.6 84.9 -84 c 0.1 -46.6 -37.2 -84.4 -84.2 -84.6 C 432.2 472.1 397.9 518.3 401.3 556.7 Z" />
            </g>
          </svg>
        <h2>Facebook Open Source</h2>
      </div>
      <div class="footerSection">
        <a class="footerLink" href="https://code.facebook.com/projects/" target="_blank">开源项目</a>
        <a class="footerLink" href="https://github.com/facebook/" target="_blank">GitHub</a>
        <a class="footerLink" href="https://twitter.com/fbOpenSource" target="_blank">Twitter</a>
      </div>
      <div class="footerSection rightAlign">
        <a class="footerLink" href="https://github.com/hhvm-cn/hhvm-cn.com" target="_blank">帮助我们翻译</a>
      </div>
    </div>
  </div>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49208336-2', 'auto');
  ga('send', 'pageview');
</script>

    </div>
  </body>
</html>
